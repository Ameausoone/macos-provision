---
# tasks file for mac-dev-playbook

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  # become: true
  with_items:
    - "{{ansible_env.HOME}}/.ansible"
    - "{{ansible_env.HOME}}/.zshrc.d"
    - "{{ansible_env.HOME}}/.terraform.d/plugin-cache"
    - "{{ansible_env.HOME}}/.config"
    - "{{ansible_env.HOME}}/.zshrc.d/core"

- name: Copy recursively files in HOME directory to $HOME
  copy:
    src: "HOME/"
    dest: "{{ansible_env.HOME}}/"
  notify: execute source shell_dotfile
  tags:
    - dotfiles

- name: Copy templated dot files
  template:
    src: "dotfiles/{{ item.src }}"
    dest: "{{ansible_env.HOME}}/{{ item.dest }}"
    mode: 0744
  loop:
    - {src: ".gitconfig.j2", dest: ".gitconfig"}
  notify: execute source shell_dotfile
  tags:
    - dotfiles

- name: Copy zsh files
  copy:
    src: ".zshrc.d/core/"
    dest: "{{ansible_env.HOME}}/.zshrc.d/core/"
    mode: 0744
  notify: execute source shell_dotfile
  tags:
    - dotfiles

- name: Calculate sha1sum of .env file
  ansible.builtin.stat:
    # Get file in roles directory
    path: "{{ role_path }}/files/HOME/.env"
    checksum_algorithm: sha1
    get_checksum: yes
  register: autoenv_sha1sum

- name: Add line in autoenv_authorized
  ansible.builtin.lineinfile:
    path: "{{ansible_env.HOME}}/.autoenv_authorized"
    line: "{{ansible_env.HOME}}/.env:{{autoenv_sha1sum.stat.checksum}}"
    state: present
    regexp: '{{ansible_env.HOME}}/\.env:.*'

- name: Copy scripts files
  copy:
    src: "scripts/"
    dest: "{{ansible_env.HOME}}/scripts/"
    mode: 0744
  tags:
    - dotfiles
